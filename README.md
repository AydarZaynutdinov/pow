# Proof of Work service

## Overview

[Proof of Work](https://en.wikipedia.org/wiki/Proof_of_work) is a form of cryptographic proof in which one party (the
prover) proves to others (the verifiers) that a certain amount of a specific computational effort has been expended.
Using this mechanism service could be sure that client has done some amount of work/calculations and service can send to
client required data.

This schema allows using different protocols. One of them is challenge-response protocol.

PoW algorithm also includes different algorithms. This service uses hashes and finding some number of leading
elements (`0`). This algorithm allows check solution much easier than find the solution and difficulty of the
algorithm could be easily changed (increasing leading elements number).

### Service

This service has 2 HTTP endpoints for handling Proof of Work. It returns
a `challenge` and `difficulty`. The client needs to find a `solution` that meets the condition:

```
SHA-256(challenge + solution) has {difficulty} leading zeros
```

When the client requests a `challenge`, it is saved in the cache (Redis) with a specified time-to-live (TTL). This
allows checking if the `solution` matches the generated `challenge` on server side and was not just generated by client.

After sending correct solution client receives one of random quotes (quotes is placed in the config file)

Redis is used to be able to run this service as several pod app with load-balancing mechanism between server and
clients.

### Client

The project also includes a simple client that sends requests to the service every 30 seconds.

## API

API for the service could be found in the [Openapi file](/api/pow-openapi.yaml).

## How to run

### Docker

You can easily run the service and client with a single `docker-compose` command:

```docker
docker-compose up --build
```

This command starts the [docker-compose file](./docker-compose.yml) which includes `redis`, `server` and `client`.

### Locally

If you want to run it locally, you need to:

- Install and run [Redis](https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/docker/)
- Run the [server](./cmd/pow-server/main.go)
- Run the [client](./cmd/pow-server/main.go) (optional)

For the server, you can specify the config file path using the `-config` flag, or it will use the
default [config file](/config/config.dev.yaml).

## How to test

There is a [Makefile](./Makefile) that contains `all-test-one-command`. This command runs docker-compose file (to run
Redis) and then build and run service. After that it runs unit and integration tests.

## Maintenance

The service collects several metrics during its operation. You can view them at (http://127.0.0.1:8081/metrics):

| Name | Type | Labels | Description | 
|---|---|---|---|
| http_requests_total | `counter` | `path`, `code` | Total number of HTTP requests |
| http_response_times | `histogram` | `path`, `code` | Response times in ms |
| cache_requests_total | `counter` | `method`, `status` | Total number of cache requests |
| cache_response_times | `histogram` | `method`, `status` | Response times in ms |
| errors_total | `counter` | `level` | Total number of errors |

## Structure

```
|-- pow
   |-- api                      // OpenAPI documentation
   |-- cmd
      |-- pow-client            // client entrypoint
      |-- pow-server            // service entrypoint
   |-- config                   // configuration files
   |-- internal
      |-- cache                 // cache logic
      |-- config                // configuration entities
      |-- controller
         |-- api                // main service handlers
         |-- maintenance        // maintenance service handlers
      |-- infrastructure
         |-- server             // code to run the HTTP server
      |-- logger                // logging
      |-- metrics               // service metrics
      |-- service
         |-- challenge          // main service logic
```